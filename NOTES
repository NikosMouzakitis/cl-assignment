##	Task1 Manual set up of docker and 
#	manual-instruction inside container
#
	#Docker script execute with shared folder to "extract" artifacts-rpms.
	docker run -it --rm \
	  -u 0 \
	  -v "$PWD:/work" \   #visible in container under /work
	  stream8-kernel-builder \
	  /bin/bash

	#once on the Docker VM.
	[root@764ba3dcf6c8 work]# history
	      cd /work/
	      rpm -ivh kernel-4.18.0-448.el8.src.rpm 
	      dnf -y builddep /root/rpmbuild/SPECS/kernel.spec
	      rpmbuild -bb /root/rpmbuild/SPECS/kernel.spec
		#verify rpm's are actually there.
	      ls /root/rpmbuild/RPMS/x86_64/*.rpm  
		 #prepere directory on host.
	      mkdir -p /work/out/rpms   
		#move to host.
	      cp -av /root/rpmbuild/RPMS/x86_64/* /work/out/rpms/   


##task2 Golang automation for creation of RPMs.
    mkdir cmd
    vi cmd/main.go
    mkdir -p cmd/build-stream8-kernel
    vi cmd/build-stream8-kernel/go.mod
    go build -o build-stream8-kernel ./cmd/build-stream8-kernel
    mkdir -p out_go_test
	##example using the vanilla src.rpm and output on out_go_test directory.
   ./build-stream8-kernel ./kernel-4.18.0-448.el8.src.rpm ./out_go_test/
	#example usage using the same srpm but from provided URL
    mkdir -p out_go_url
   ./build-stream8-kernel  "https://vault.centos.org/8-stream/BaseOS/Source/SPackages/kernel-4.18.0-448.el8.src.rpm" ./out_go_url


##Task3 Patches application using the Go tool.
		
	#run container and prepare SPRM
	rpm -ivh kernel-4.18.0-448.el8.src.rpm 
	dnf -y builddep /root/rpmbuild/SPECS/kernel.spec
	cd /root/rpmbuild/SOURCES
	curl -L -o 80e648042e512d5a767da251d44132553fe04ae0.patch  "https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=80e648042e512d5a767da251d44132553fe04ae0"
	curl -L -o f90fff1e152dedf52b932240ebbd670d83330eca.patch  "https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=f90fff1e152dedf52b932240ebbd670d83330eca
	##modify kernel.spec to include the patches.
	
	
	rpmbuild -bb /root/rpmbuild/SPECS/kernel.spec  # this will fail with error.
	#previous fails, created BUILD/kernel sources
	git init  > /dev/null 
	git add -A
	git commit -m baseline > /dev/null
	#manual modifications for patch needing.
	git diff > ~/rpmbuild/SOURCES/f9****<patchhash>.patch

	#getting the SRPM
	rpmbuild --bs ~/rpmbuild/SPECS/kernel.spec --define "buildid .task3"
	cp ~/rpmbuild/SRPM/kernel-4.18.0-448.el8.task3.src.rpm /work

	#then use the Go tool to produce in patched_rpms folder the binaries.
	./builder-stream8-kernel kernel-4.18.0-448.el8.task3.src.rpm patched_rpms

	# after tool finishes we can run verify to inspect
	# source with GDB .e,g. list run_posix_cpu_timers or list mac_partition
	# and inspect inside the source code that changes are applied.	
	./verify.sh

